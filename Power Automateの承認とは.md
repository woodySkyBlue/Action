# 🚀 **Power Automate の承認とは？**

Power Automate の承認は、単なる「承認ボタン」ではなく、  
**通知・レスポンス管理・履歴・再送・代替承認・Teams 連携・Dataverse 保存**まで含む、かなり強力なワークフロー基盤です。

Power Automate の承認（Approvals）は、  
**人間による承認・却下をフローの中で扱うための仕組み**です。

- 承認依頼を送る  
- 承認者が Teams / メール / Power Automate アプリで応答  
- 結果（承認/却下/コメント）をフローで受け取る  
- その後の処理を分岐させる  

という一連の流れを自動化できます。

---

# 🧩 **承認の種類（4種類）**

Power Automate には承認アクションが複数あります。

## ✔ 1. **承認 – 承認者を指定して承認を依頼**
最も基本的な承認。

- 承認 / 却下  
- コメント  
- 添付ファイル（Dataverse 版のみ）  
- Teams 通知

## ✔ 2. **すべての承認者が応答する必要がある（全員承認）**
全員が承認しないと承認にならない。

## ✔ 3. **最初の応答者（First to respond）**
誰か1人が承認すれば承認扱い。

## ✔ 4. **カスタム応答（Custom Responses）**
承認/却下以外の選択肢を作れる。

例：  
- 「承認」「差し戻し」「却下」  
- 「確認済み」「保留」「再提出」  

---

# 📬 **承認依頼の送信方法**

承認依頼は以下のチャネルに自動で送られます。

- **Teams（推奨）**  
- **メール（Outlook）**  
- **Power Automate モバイルアプリ**  
- **Power Automate ポータル（Approvals Center）**

Teams との統合が非常に強力で、  
承認者は Teams の通知から直接承認できます。

---

# 🧭 **承認アクションの内部構造（重要）**

承認アクションは、実は裏側で **Dataverse の Approvals テーブル**にレコードを作成しています。

保存される情報：

- 承認依頼 ID  
- 承認者  
- 承認/却下  
- コメント  
- 添付ファイル（Dataverse 版）  
- タイムスタンプ  
- 状態（Pending / Approved / Rejected）

これにより、**履歴が自動で残る**のが大きなメリットです。

---

# 🔀 **承認結果の分岐**

承認アクションの後に **条件分岐（Condition）**を置きます。

```
@equals(outputs('承認').outcome, 'Approve')
```

outcome の値は：

| 結果 | outcome の値 |
|------|--------------|
| 承認 | Approve |
| 却下 | Reject |
| カスタム応答 | その応答名 |

---

# 🧪 **実務でよく使う承認フローパターン（明浩さん向け）**

---

## ✔ パターン1：単純な承認 → メール通知
1. 承認を依頼  
2. 承認されたらメール送信  
3. 却下されたら別のメール送信

---

## ✔ パターン2：多段階承認（一次 → 二次）
1. 一次承認者へ依頼  
2. 承認されたら二次承認者へ依頼  
3. 最終結果を通知

---

## ✔ パターン3：金額による承認者の切り替え
```
If 金額 > 100万円 → 部長  
Else → 課長
```

---

## ✔ パターン4：Teams で承認 → SharePoint に記録
- 承認結果  
- コメント  
- 承認者  
- 承認日時  

を SharePoint リストに保存。

---

## ✔ パターン5：承認後に Power Apps に戻す（Power Apps 連携）
Power Apps → Power Automate → 承認 → 結果を Power Apps に返す  
という双方向連携。

---

# ⚠️ **承認の注意点（重要）**

あなたのようにロジックの整合性を重視する方には特に重要です。

### ❗ 1. 承認者が外部ユーザーだと承認できない  
（Azure AD 外のユーザーは不可）

### ❗ 2. 承認依頼の再送は自動では行われない  
必要ならフローで再送ロジックを作る。

### ❗ 3. 承認アクションは「待機」する  
承認されるまでフローが止まる。

### ❗ 4. 承認者が複数の場合、動作が種類によって異なる  
- 全員承認  
- 最初の応答者  
- カスタム応答

### ❗ 5. Approvals の Dataverse テーブルは削除しない  
履歴が消える。

---

# 🎯 **明浩さん向け：承認フロー設計の最適指針**

あなたの開発スタイルに合わせると：

### ✔ まずは「承認 – 承認者を指定して承認を依頼」を使う  
→ 最も安定していて、Teams 連携も強い

### ✔ 承認結果は必ず SharePoint / Dataverse に保存  
→ 後から分析・監査ができる

### ✔ 承認者の動的切り替えは「Switch」か「条件分岐」で  
→ 金額・部署・申請種別などで柔軟に

### ✔ 多段階承認は「承認 → 条件 → 次の承認」の直列構造  
→ 再現性が高い

---

# 📘 必要なら…

- 承認フローのテンプレート（一次・二次・三次）  
- 承認者を動的に決めるロジック  
- 承認履歴を SharePoint に保存する設計  
- Power Apps と承認フローの連携例  

こういった実務的な資料も作れます。
